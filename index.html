<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Innovation Workshop Tool | Chock</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=PT+Sans+Narrow:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #000000;
            color: white;
            padding: 30px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 30px;
        }
        
        .logo {
            width: 80px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .header h1 {
            font-family: 'PT Sans Narrow', sans-serif;
            font-size: 2.5em;
            margin: 0;
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .progress-bar {
            height: 8px;
            background: rgba(255,255,255,0.2);
            margin-top: 20px;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #fff;
            width: 10%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }
        
        .phase-indicator {
            background: #f5f5f5;
            padding: 15px 40px;
            border-bottom: 2px solid #e0e0e0;
            text-align: center;
            font-family: 'PT Sans Narrow', sans-serif;
            font-size: 1.1em;
            color: #666;
        }
        
        .phase-indicator.active {
            background: #000000;
            color: white;
        }
        
        .main-content {
            padding: 40px;
        }
        
        .step {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }
        
        .step.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .step-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .step-number {
            display: inline-block;
            width: 60px;
            height: 60px;
            background: #000000;
            color: white;
            border-radius: 50%;
            font-size: 24px;
            font-weight: bold;
            line-height: 60px;
            margin-bottom: 15px;
        }
        
        .step-title {
            font-size: 2em;
            color: #000000;
            margin-bottom: 10px;
            font-family: 'PT Sans Narrow', sans-serif;
        }
        
        .step-description {
            font-size: 1.1em;
            color: #666;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .scenario-probability {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .scenario-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #000000;
            margin-bottom: 10px;
        }
        
        .scenario-description {
            color: #666;
            margin-bottom: 15px;
        }
        
        .probability-control {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .probability-slider {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #e0e0e0;
            border-radius: 4px;
            outline: none;
        }
        
        .probability-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #000000;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .probability-value {
            min-width: 60px;
            font-size: 1.2em;
            font-weight: bold;
            text-align: right;
        }
        
        .total-probability {
            background: #fff;
            border: 3px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            font-size: 1.3em;
            font-weight: bold;
            margin-top: 20px;
        }
        
        .total-probability.valid {
            background: #f0f8f0;
            border-color: #4caf50;
            color: #2e7d32;
        }
        
        .total-probability.invalid {
            background: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: #000000;
            margin-bottom: 8px;
            font-size: 1.1em;
            font-family: 'PT Sans Narrow', sans-serif;
        }
        
        .form-input, .form-textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }
        
        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #000000;
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .uncertainty-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .uncertainty-item {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
        }
        
        .uncertainty-input {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 16px;
            padding: 5px 0;
        }
        
        .uncertainty-input:focus {
            outline: none;
            border-bottom: 2px solid #000000;
        }
        
        .ladder-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .ladder-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .ladder-letter {
            display: inline-block;
            width: 40px;
            height: 40px;
            background: #000000;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 40px;
            font-weight: bold;
            margin-right: 15px;
            margin-bottom: 10px;
        }
        
        .ladder-field {
            margin-bottom: 20px;
        }
        
        .ladder-label {
            font-weight: 600;
            color: #000000;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            font-family: 'PT Sans Narrow', sans-serif;
            font-size: 1.3em;
        }
        
        .ladder-hint {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
            font-style: italic;
        }
        
        .buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
            gap: 20px;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-align: center;
            font-family: 'PT Sans Narrow', sans-serif;
        }
        
        .btn-primary {
            background: #000000;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            opacity: 0.8;
        }
        
        .btn-secondary {
            background: #666666;
            color: white;
        }
        
        .btn-gemini {
            background: linear-gradient(90deg, #4285F4, #9B72CB, #D96570, #F2A600);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .ai-response {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .ai-response-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .ai-response-header strong {
            margin-right: auto;
        }
        
        .ai-icon {
            width: 30px;
            height: 30px;
            background: #000000;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }
        
        .prompt-output {
            background: #fafafa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        
        .summary-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }
        
        .summary-title {
            font-size: 1.5em;
            color: #000000;
            margin-bottom: 15px;
            font-weight: bold;
            font-family: 'PT Sans Narrow', sans-serif;
        }
        
        .export-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }
        
        .settings-btn {
            background: transparent;
            border: 2px solid white;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
        }
        
        .settings-btn:hover {
            background: white;
            color: black;
        }
        
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .settings-content {
            background: white;
            max-width: 900px;
            margin: 50px auto;
            padding: 40px;
            border-radius: 12px;
            position: relative;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .settings-header h2 {
            font-family: 'PT Sans Narrow', sans-serif;
            font-size: 2em;
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #666;
        }
        
        .close-btn:hover {
            color: #000;
        }
        
        .scenario-editor {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8f9fa;
            position: relative;
        }
        
        .scenario-editor h4 {
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        .editor-field {
            margin-bottom: 15px;
        }
        
        .editor-field label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #666;
        }
        
        .editor-field input, .editor-field textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .editor-field textarea {
            min-height: 80px;
            resize: vertical;
        }

        .remove-scenario-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #e74c3c;
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
        }
        .remove-scenario-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .settings-actions {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            margin-top: 30px;
            align-items: center;
        }
        
        .save-settings-btn {
            background: #000;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .save-settings-btn:hover {
            opacity: 0.8;
        }
        
        .context-info {
            background: #f0f8ff;
            border: 1px solid #4682b4;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .context-info h4 {
            margin: 0 0 10px 0;
            color: #4682b4;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .uncertainty-list {
                grid-template-columns: 1fr;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .header-left {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .logo {
                width: 60px;
                height: 30px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .settings-modal {
                padding: 20px;
            }
            
            .settings-content {
                margin: 20px;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="logo">
                    <svg viewBox="0 0 2029 919" style="width: 100%; height: 100%; fill: white;">
                        <g transform="matrix(1,0,0,1,-201,-198)">
                            <path d="M1168.95,386.932C1237.67,502.99 1254.13,971.656 1221.96,1020.63C1189.77,1069.59 336.639,1116.89 277.999,1029.83C214.467,935.491 289.327,371.211 383.761,260.786C478.194,150.362 1136.25,331.694 1168.95,386.932ZM1078.01,445.901C1052.58,403.022 499.499,300.884 450.836,357.502C377.266,443.109 333.177,910.835 363.217,956.576C396.119,1006.7 1094.2,975.869 1119.22,937.853C1144.23,899.837 1131.43,536.002 1078.01,445.901Z" style="fill:white;stroke:white;stroke-width:1px;"/>
                        </g>
                        <g transform="matrix(1,0,0,1,-201,-198)">
                            <path d="M1394.46,583.154C1354.11,583.154 1318.09,604.768 1298.64,641.153C1287.11,662.768 1281.7,687.624 1281.7,718.965C1281.7,755.71 1291.79,785.971 1311.96,808.666C1332.5,832.082 1359.16,843.249 1393.74,843.249C1422.2,843.249 1443.45,836.044 1463.27,819.833L1440.21,788.132C1438.41,789.573 1436.61,791.014 1435.17,792.095C1422.92,800.38 1411.03,804.343 1397.34,804.343C1375.73,804.343 1359.16,794.616 1349.07,776.244C1341.51,762.555 1338.62,743.462 1338.62,709.239C1338.62,680.059 1342.95,659.165 1352.67,644.755C1361.68,631.426 1378.25,623.141 1395.18,623.141C1409.23,623.141 1422.56,627.824 1435.17,637.19L1457.86,602.967C1444.17,591.079 1419.32,583.154 1394.46,583.154Z" style="fill:white;fill-rule:nonzero;"/>
                        </g>
                        <g transform="matrix(1,0,0,1,-201,-198)">
                            <path d="M1486.32,625.663L1486.32,838.926L1535.31,838.926L1535.31,706.717C1546.12,696.991 1561.61,689.786 1573.5,689.786C1587.19,689.786 1592.23,696.63 1592.23,715.003L1592.23,838.926L1639.42,838.926L1639.42,709.959C1639.42,689.065 1638.34,686.183 1634.74,675.736C1628.98,660.246 1609.52,649.439 1586.83,649.439C1568.1,649.439 1547.2,657.364 1534.59,669.252C1534.59,667.09 1535.31,659.525 1535.31,653.761L1535.31,617.017C1535.31,599.365 1534.23,582.073 1532.07,571.986L1482.72,583.514C1484.88,591.079 1486.32,608.371 1486.32,625.663Z" style="fill:white;fill-rule:nonzero;"/>
                        </g>
                        <g transform="matrix(1,0,0,1,-201,-198)">
                            <path d="M1672.93,747.425C1672.93,805.424 1705.71,842.889 1755.79,842.889C1784.25,842.889 1802.62,833.162 1816.67,817.312C1832.52,799.3 1839.72,777.685 1839.72,745.984C1839.72,716.083 1833.24,695.91 1818.47,678.618C1802.62,659.886 1782.08,650.88 1755.79,650.88C1706.07,650.88 1672.93,689.426 1672.93,747.425ZM1777.4,696.27C1783.88,704.556 1787.13,720.767 1787.13,745.623C1787.13,789.213 1778.12,807.945 1757.23,807.945C1747.86,807.945 1737.05,802.902 1732.73,792.815C1728.77,783.449 1726.61,767.598 1726.61,746.344C1726.61,727.972 1728.41,715.003 1731.65,705.276C1735.61,693.748 1744.98,686.544 1756.51,686.544C1765.15,686.544 1772.72,690.146 1777.4,696.27Z" style="fill:white;fill-rule:nonzero;"/>
                        </g>
                        <g transform="matrix(1,0,0,1,-201,-198)">
                            <path d="M1981.65,657.364C1971.2,652.32 1958.24,649.078 1945.99,649.078C1930.5,649.078 1912.48,654.482 1900.24,662.768C1878.62,677.538 1862.41,705.636 1862.41,748.145C1862.41,807.945 1891.95,843.249 1942.74,843.249C1960.4,843.249 1974.81,839.287 1987.78,831.721C1994.26,827.759 1997.5,825.237 2004.71,818.032L1982.73,788.853L1979.85,791.374C1967.96,801.821 1957.87,806.504 1946.71,806.504C1938.42,806.504 1930.14,802.542 1925.09,796.057C1918.61,788.132 1915.73,773.722 1915.73,749.586C1915.73,706.357 1925.45,687.624 1947.07,687.624C1956.07,687.624 1966.52,693.028 1976.25,702.034L1999.66,670.333C1991.74,663.488 1988.5,660.966 1981.65,657.364Z" style="fill:white;fill-rule:nonzero;"/>
                        </g>
                        <g transform="matrix(1,0,0,1,-201,-198)">
                            <path d="M2074.96,734.456L2136.92,838.926L2193.84,838.926L2121.43,731.574L2180.15,653.761L2122.15,653.761L2074.96,734.456ZM2025.61,631.066L2025.61,838.926L2073.88,838.926L2073.88,631.066C2073.88,606.57 2073.16,584.955 2071,571.266L2022.37,583.154C2025.25,602.247 2025.61,614.855 2025.61,631.066Z" style="fill:white;fill-rule:nonzero;"/>
                        </g>
                    </svg>
                </div>
                <div>
                    <h1>AI Innovation Workshop</h1>
                    <p>Probabilistic Future Planning & LADDER Analysis</p>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                 <button id="settingsBtn" class="settings-btn" title="Workshop Scenario Setup">‚öôÔ∏è</button>
            </div>
        </div>
        
        <div class="phase-indicator active" id="phaseIndicator">
            Phase 1: Probabilistic Future Synthesis
        </div>
        
        <!-- Settings Modal -->
        <div class="settings-modal" id="settingsModal">
            <div class="settings-content">
                <div class="settings-header">
                    <h2>Workshop Scenario Setup</h2>
                    <button id="closeSettingsBtn" class="close-btn">√ó</button>
                </div>
                
                <div class="context-info">
                    <h4>üìù Admin: Define 10-Year Scenarios</h4>
                    <p>Input 4-6 foundational scenarios. Participants will use these to build a 2-year (2027) future.</p>
                </div>
                
                <div id="scenarioEditors">
                    <!-- Scenario editors will be populated here by JavaScript -->
                </div>
                
                <div class="settings-actions">
                    <button class="btn btn-secondary" id="addScenarioBtn">+ Add Scenario</button>
                    <button class="save-settings-btn" id="saveSettingsBtn">Save & Apply Scenarios</button>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Step 1: Team Setup -->
            <div class="step active" id="step1">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <h2 class="step-title">Team Setup</h2>
                    <p class="step-description">Let's start by setting up your team information</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="teamName">Team Name</label>
                    <input type="text" class="form-input" id="teamName" placeholder="e.g., Innovation Explorers">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="teamContext">Team Context (Optional)</label>
                    <input type="text" class="form-input" id="teamContext" placeholder="e.g., Cross-functional innovation team, Strategic planning group">
                </div>
                
                <div class="buttons">
                    <div></div>
                    <button class="btn btn-primary" id="step1Next">Begin Scenario Planning ‚Üí</button>
                </div>
            </div>
            
            <!-- Step 2: Probability Assignment -->
            <div class="step" id="step2">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <h2 class="step-title">Assign Scenario Probabilities</h2>
                    <p class="step-description">What's the likelihood of each 10-year scenario by 2035? Distribute 100% across all scenarios.</p>
                </div>

                <div id="scenario-probability-container">
                    <!-- Scenarios from settings will be populated here -->
                </div>
                
                <div class="total-probability" id="totalProbability">
                    Total: <span id="totalValue">100%</span>
                </div>
                
                <div class="buttons">
                    <button class="btn btn-secondary" id="step2Prev">‚Üê Back</button>
                    <button class="btn btn-primary" id="step2Next">Add Context & Uncertainties ‚Üí</button>
                </div>
            </div>
            
            <!-- Step 3: Uncertainties & Context -->
            <div class="step" id="step3">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <h2 class="step-title">Add Context & Uncertainties</h2>
                    <p class="step-description">What uncertainties could affect these scenarios? How do they apply to your industry?</p>
                </div>
                
                <div class="summary-section">
                    <div class="summary-title">Your Probability Distribution:</div>
                    <div id="probabilitySummary"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Your Top 3 Uncertainties</label>
                    <p style="color: #666; margin-bottom: 20px;">What could accelerate or derail these scenarios? What wild cards might emerge?</p>
                    
                    <div class="uncertainty-list">
                        <div class="uncertainty-item">
                            <input type="text" class="uncertainty-input" placeholder="e.g., Regulatory restrictions on AI decision-making" id="uncertainty1">
                        </div>
                        <div class="uncertainty-item">
                            <input type="text" class="uncertainty-input" placeholder="e.g., Workforce resistance to AI collaboration" id="uncertainty2">
                        </div>
                        <div class="uncertainty-item">
                            <input type="text" class="uncertainty-input" placeholder="e.g., Cybersecurity threats to predictive systems" id="uncertainty3">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="industryContext">Your Business/Industry Context</label>
                    <p style="color: #666; margin-bottom: 10px;">How would these scenarios specifically manifest in your industry? What unique factors apply?</p>
                    <textarea class="form-textarea" id="industryContext" placeholder="e.g., In healthcare, AI decision acceleration would transform diagnosis and treatment planning..."></textarea>
                </div>
                
                <div class="buttons">
                    <button class="btn btn-secondary" id="step3Prev">‚Üê Back</button>
                    <button class="btn btn-primary" id="step3Next">Synthesize 2027 Future ‚Üí</button>
                </div>
            </div>
            
            <!-- Step 4: Synthesized Future -->
            <div class="step" id="step4">
                <div class="step-header">
                    <div class="step-number">4</div>
                    <h2 class="step-title">Your Synthesized 2027 Future</h2>
                    <p class="step-description">Based on your probabilities and context, generate your unique 2-year future scenario.</p>
                </div>
                
                <div class="ai-response">
                    <div class="ai-response-header">
                        <div class="ai-icon">ü§ñ</div>
                        <strong>Generate Your Probabilistic Future</strong>
                        <button class="btn btn-secondary" id="generateFutureBtn" style="margin-left: auto;">Generate Synthesis Prompt</button>
                    </div>
                    <div class="prompt-output" id="synthesisPrompt" style="display: none;">
                        <!-- Synthesis prompt will appear here -->
                    </div>
                    <button class="btn btn-secondary" id="copySynthesisBtn" style="display: none; margin-top: 10px;">üìã Copy Prompt</button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Paste AI Response Here:</label>
                    <textarea class="form-textarea" id="synthesizedFutureText" placeholder="After generating and using the synthesis prompt above, paste the AI's synthesized future scenario here..." style="min-height: 200px;"></textarea>
                </div>
                
                <div class="buttons">
                    <button class="btn btn-secondary" id="step4Prev">‚Üê Back</button>
                    <button class="btn btn-primary" id="step4Next" disabled>Begin Goal Setting ‚Üí</button>
                </div>
            </div>
            
            <!-- Step 5: Goal Setting LADDER -->
            <div class="step" id="step5">
                <div class="step-header">
                    <div class="step-number">5</div>
                    <h2 class="step-title">Stage 1: Goal Setting</h2>
                    <p class="step-description">Use LADDER to craft breakthrough goals for your synthesized future</p>
                </div>
                
                <div class="summary-section">
                    <div class="summary-title">Your 2027 Future Scenario:</div>
                    <div id="futureScenarioSummary" style="font-style: italic;"></div>
                </div>
                
                <div class="ladder-section">
                    <div class="ladder-field">
                        <div class="ladder-label">
                            <span class="ladder-letter">L</span>
                            LEAD - Your Breakthrough Goal
                        </div>
                        <div class="ladder-hint">What specific breakthrough do you want to achieve in this future?</div>
                        <textarea class="form-textarea" id="goalLead" placeholder="By December 2027, [organization/industry] will achieve [specific outcome] resulting in [measurable impact]"></textarea>
                    </div>
                    
                    <div class="ladder-field">
                        <div class="ladder-label">
                            <span class="ladder-letter">A</span>
                            ANCHOR - Current Reality
                        </div>
                        <div class="ladder-hint">What data, metrics, and facts ground your goal in today's reality?</div>
                        <textarea class="form-textarea" id="goalAnchor" placeholder="Current state metrics, costs, inefficiencies, market data..."></textarea>
                    </div>
                    
                    <div class="ladder-field">
                        <div class="ladder-label">
                            <span class="ladder-letter">D</span>
                            DETAIL - Strategic Reasoning
                        </div>
                        <div class="ladder-hint">Why is this goal achievable given your synthesized future?</div>
                        <textarea class="form-textarea" id="goalDetail" placeholder="Given the future scenario, this goal is achievable because..."></textarea>
                    </div>
                    
                    <div class="ladder-field">
                        <div class="ladder-label">
                            <span class="ladder-letter">D</span>
                            DECLARE - Critical Assumptions
                        </div>
                        <div class="ladder-hint">What must be true for this goal to succeed?</div>
                        <textarea class="form-textarea" id="goalDeclare" placeholder="Key assumptions about technology, market, organization..."></textarea>
                    </div>
                    
                    <div class="ladder-field">
                        <div class="ladder-label">
                            <span class="ladder-letter">E</span>
                            EXPLAIN - Analysis Needed
                        </div>
                        <div class="ladder-hint">What help do you need to validate this goal?</div>
                        <textarea class="form-textarea" id="goalExplain" placeholder="Need analysis of feasibility, risks, success factors..."></textarea>
                    </div>
                    
                    <div class="ladder-field">
                        <div class="ladder-label">
                            <span class="ladder-letter">R</span>
                            REQUEST - Goal Validation
                        </div>
                        <div class="ladder-hint">What specific outputs do you want?</div>
                        <textarea class="form-textarea" id="goalRequest" placeholder="(1) Refined goal statement, (2) Success metrics, (3) Risk assessment..."></textarea>
                    </div>
                </div>
                
                <div class="buttons">
                    <button class="btn btn-secondary" id="step5Prev">‚Üê Back</button>
                    <button class="btn btn-primary" id="step5Next">Generate Goal Analysis ‚Üí</button>
                </div>
            </div>

            <!-- Step 6: Goal Analysis Results -->
            <div class="step" id="step6">
                <div class="step-header">
                    <div class="step-number">6</div>
                    <h2 class="step-title">Goal Analysis Results</h2>
                    <p class="step-description">Review your goal analysis and paste the AI response</p>
                </div>
                
                <div class="ai-response">
                    <div class="ai-response-header">
                        <div class="ai-icon">üìã</div>
                        <strong>Generated LADDER Prompt - Goal Setting</strong>
                        <button class="btn btn-secondary" id="copyGoalBtn" style="margin-left: auto;">üìã Copy Prompt</button>
                    </div>
                    <div class="prompt-output" id="goalPromptOutput"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Paste AI Response Here:</label>
                    <textarea class="form-textarea" id="goalAIResponse" placeholder="After using the prompt above with your AI tool, paste the goal analysis response here..." style="min-height: 200px;"></textarea>
                </div>
                
                <div class="buttons">
                    <button class="btn btn-secondary" id="step6Prev">‚Üê Refine Goal</button>
                    <button class="btn btn-primary" id="step6Next" disabled>Begin Assumptions ‚Üí</button>
                </div>
            </div>

            <!-- Step 7: Assumption Mapping -->
            <div class="step" id="step7">
                <div class="step-header">
                    <div class="step-number">7</div>
                    <h2 class="step-title">Stage 2: Assumption Mapping</h2>
                    <p class="step-description">Identify and test critical assumptions for your goal</p>
                </div>
                
                <div class="summary-section">
                    <div class="summary-title">Your Goal:</div>
                    <div id="goalSummary" style="font-style: italic;"></div>
                </div>
                
                <div class="ladder-section">
                    <div class="ladder-field">
                        <div class="ladder-label">
                            <span class="ladder-letter">L</span>
                            LEAD - Assumption Discovery
                        </div>
                        <div class="ladder-hint">What assumptions underlie your goal's success?</div>
                        <textarea class="form-textarea" id="assumptionLead" placeholder="Identify critical assumptions for achieving: [your goal]"></textarea>
                    </div>
                    
                    <div class="ladder-field">
                        <div class="ladder-label">
                            <span class="ladder-letter">A</span>
                            ANCHOR - Context & Evidence
                        </div>
                        <div class="ladder-hint">What evidence supports or challenges these assumptions?</div>
                        <textarea class="form-textarea" id="assumptionAnchor" placeholder="Current trends, analogous cases, market signals..."></textarea>
                    </div>
                    
                    <div class="ladder-field">
                        <div class="ladder-label">
                            <span class="ladder-letter">D</span>
                            DETAIL - Assumption Categories
                        </div>
                        <div class="ladder-hint">How do assumptions span technology, market, organization, and ecosystem?</div>
                        <textarea class="form-textarea" id="assumptionDetail" placeholder="Technology readiness, market acceptance, organizational capability..."></textarea>
                    </div>
                    
                    <div class="ladder-field">
                        <div class="ladder-label">
                            <span class="ladder-letter">D</span>
                            DECLARE - Testing Priorities
                        </div>
                        <div class="ladder-hint">Which assumptions are most critical to test first?</div>
                        <textarea class="form-textarea" id="assumptionDeclare" placeholder="High-impact assumptions, quick tests, dependencies..."></textarea>
                    </div>
                    
                    <div class="ladder-field">
                        <div class="ladder-label">
                            <span class="ladder-letter">E</span>
                            EXPLAIN - Testing Methods
                        </div>
                        <div class="ladder-hint">What help do you need to design assumption tests?</div>
                        <textarea class="form-textarea" id="assumptionExplain" placeholder="Need methods for validation, experiments, evidence gathering..."></textarea>
                    </div>
                    
                    <div class="ladder-field">
                        <div class="ladder-label">
                            <span class="ladder-letter">R</span>
                            REQUEST - Assumption Analysis
                        </div>
                        <div class="ladder-hint">What specific outputs do you want?</div>
                        <textarea class="form-textarea" id="assumptionRequest" placeholder="(1) Assumption map, (2) Testing plan, (3) Risk assessment..."></textarea>
                    </div>
                </div>
                
                <div class="buttons">
                    <button class="btn btn-secondary" id="step7Prev">‚Üê Back</button>
                    <button class="btn btn-primary" id="step7Next">Generate Assumption Analysis ‚Üí</button>
                </div>
            </div>

            <!-- Step 8: Assumption Analysis Results -->
            <div class="step" id="step8">
                <div class="step-header">
                    <div class="step-number">8</div>
                    <h2 class="step-title">Assumption Analysis Results</h2>
                    <p class="step-description">Review your assumption analysis and paste the AI response</p>
                </div>
                
                <div class="ai-response">
                    <div class="ai-response-header">
                        <div class="ai-icon">üìã</div>
                        <strong>Generated LADDER Prompt - Assumption Mapping</strong>
                        <button class="btn btn-secondary" id="copyAssumptionBtn" style="margin-left: auto;">üìã Copy Prompt</button>
                    </div>
                    <div class="prompt-output" id="assumptionPromptOutput"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Paste AI Response Here:</label>
                    <textarea class="form-textarea" id="assumptionAIResponse" placeholder="After using the prompt above with your AI tool, paste the assumption analysis response here..." style="min-height: 200px;"></textarea>
                </div>
                
                <div class="buttons">
                    <button class="btn btn-secondary" id="step8Prev">‚Üê Refine Assumptions</button>
                    <button class="btn btn-primary" id="step8Next" disabled>Begin Pathways ‚Üí</button>
                </div>
            </div>

            <!-- Step 9: Pathway Development -->
            <div class="step" id="step9">
                <div class="step-header">
                    <div class="step-number">9</div>
                    <h2 class="step-title">Stage 3: Pathway Development</h2>
                    <p class="step-description">Map pathways from today to your goal</p>
                </div>
                
                <div class="summary-section">
                    <div class="summary-title">Your Goal & Key Assumptions:</div>
                    <div id="pathwaySummary" style="font-style: italic;"></div>
                </div>
                
                <div class="ladder-section">
                    <div class="ladder-field">
                        <div class="ladder-label">
                            <span class="ladder-letter">L</span>
                            LEAD - Pathway Mapping
                        </div>
                        <div class="ladder-hint">What pathways lead from today to your goal?</div>
                        <textarea class="form-textarea" id="pathwayLead" placeholder="Map routes from current state to goal achievement..."></textarea>
                    </div>
                    
                    <div class="ladder-field">
                        <div class="ladder-label">
                            <span class="ladder-letter">A</span>
                            ANCHOR - Starting Position
                        </div>
                        <div class="ladder-hint">What resources, capabilities, and constraints define your starting point?</div>
                        <textarea class="form-textarea" id="pathwayAnchor" placeholder="Current capabilities, resources, market position..."></textarea>
                    </div>
                    
                    <div class="ladder-field">
                        <div class="ladder-label">
                            <span class="ladder-letter">D</span>
                            DETAIL - Milestone Sequencing
                        </div>
                        <div class="ladder-hint">What milestones and decision points structure the journey?</div>
                        <textarea class="form-textarea" id="pathwayDetail" placeholder="Key milestones, dependencies, decision gates..."></textarea>
                    </div>
                    
                    <div class="ladder-field">
                        <div class="ladder-label">
                            <span class="ladder-letter">D</span>
                            DECLARE - Success Criteria
                        </div>
                        <div class="ladder-hint">How will you know you're on the right path?</div>
                        <textarea class="form-textarea" id="pathwayDeclare" placeholder="Success indicators, warning signs, pivot triggers..."></textarea>
                    </div>
                    
                    <div class="ladder-field">
                        <div class="ladder-label">
                            <span class="ladder-letter">E</span>
                            EXPLAIN - Implementation Help
                        </div>
                        <div class="ladder-hint">What help do you need for pathway implementation?</div>
                        <textarea class="form-textarea" id="pathwayExplain" placeholder="Need guidance on sequencing, resources, partnerships..."></textarea>
                    </div>
                    
                    <div class="ladder-field">
                        <div class="ladder-label">
                            <span class="ladder-letter">R</span>
                            REQUEST - Pathway Deliverables
                        </div>
                        <div class="ladder-hint">What specific outputs do you want?</div>
                        <textarea class="form-textarea" id="pathwayRequest" placeholder="(1) Implementation roadmap, (2) Resource plan, (3) Risk mitigation..."></textarea>
                    </div>
                </div>
                
                <div class="buttons">
                    <button class="btn btn-secondary" id="step9Prev">‚Üê Back</button>
                    <button class="btn btn-primary" id="step9Next">Generate Pathway Analysis ‚Üí</button>
                </div>
            </div>

            <!-- Step 10: Pathway Results & Workshop Complete -->
            <div class="step" id="step10">
                <div class="step-header">
                    <div class="step-number">‚úÖ</div>
                    <h2 class="step-title">Workshop Complete!</h2>
                    <p class="step-description">Your probabilistic future planning is ready</p>
                </div>
                
                <div class="ai-response">
                    <div class="ai-response-header">
                        <div class="ai-icon">üìã</div>
                        <strong>Generated LADDER Prompt - Pathway Development</strong>
                        <button class="btn btn-secondary" id="copyPathwayBtn" style="margin-left: auto;">üìã Copy Prompt</button>
                    </div>
                    <div class="prompt-output" id="pathwayPromptOutput"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Paste AI Response Here:</label>
                    <textarea class="form-textarea" id="pathwayAIResponse" placeholder="After using the prompt above with your AI tool, paste the pathway analysis response here..." style="min-height: 200px;"></textarea>
                </div>
                
                <div class="summary-section">
                    <div class="summary-title">üéØ Innovation Planning Summary</div>
                    <div id="workshopSummary">
                        <p><strong>Synthesized Future:</strong> <span id="futureBrief"></span></p>
                        <p><strong>Breakthrough Goal:</strong> <span id="goalBrief"></span></p>
                        <p><strong>Critical Assumptions:</strong> <span id="assumptionCount">Multiple assumptions identified</span></p>
                        <p><strong>Implementation Pathways:</strong> <span id="pathwayCount">Multiple pathways mapped</span></p>
                    </div>
                </div>
                
                <div class="summary-section">
                    <div class="summary-title">üìä Monitoring Framework</div>
                    <p>Track these signals to validate your probabilistic future:</p>
                    <ul style="margin-left: 20px;">
                        <li>Early indicators from your assumption tests</li>
                        <li>Market signals aligning with scenario probabilities</li>
                        <li>Technology readiness matching expectations</li>
                        <li>Organizational capability development</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Recommendation:</strong> Revisit probabilities quarterly as evidence emerges</p>
                </div>
                
                <div class="export-buttons">
                    <button class="btn btn-primary" id="exportBtn">üìÑ Export Full Analysis</button>
                    <button class="btn btn-primary" id="printBtn">üñ®Ô∏è Print Summary</button>
                    <button class="btn btn-secondary" id="restartBtn">üîÑ Start New Workshop</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            // --- Firebase Setup ---
            let db, auth;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.body.innerHTML = '<h1>Error: Could not connect to the workshop service. Please try again later.</h1>';
                return;
            }
            
            const scenariosDocRef = doc(db, `artifacts/${appId}/public/data/workshopScenarios/shared`);

            // --- State & Constants ---
            let currentStep = 1;
            const totalSteps = 10;
            let workshopData = {
                teamName: '',
                teamContext: '',
                probabilities: {},
                uncertainties: [],
                industryContext: '',
                synthesizedFuture: '',
                goal: {},
                assumptions: {},
                pathways: {}
            };
            
            let scenarios = {
                1: { title: 'Scenario 1: Hyper-Adoption', description: 'A world where AI is rapidly and widely adopted across all sectors, leading to massive productivity gains but also significant social disruption.' },
                2: { title: 'Scenario 2: Regulatory Gridlock', description: 'Governments and international bodies impose strict regulations on AI development and deployment, slowing innovation but ensuring safety and ethical considerations.' },
                3: { title: 'Scenario 3: Geopolitical Fragmentation', description: 'AI development splinters along geopolitical lines, creating competing tech ecosystems (e.g., US, China, EU) with limited interoperability.' },
                4: { title: 'Scenario 4: The Great Stagnation', description: 'Despite initial hype, AI progress stalls due to unforeseen technical hurdles, data limitations, or economic downturns, leading to a period of disillusionment.' }
            };

            const phases = {
                1: { name: "Phase 1: Probabilistic Future Synthesis", steps: [1, 2, 3, 4] },
                2: { name: "Phase 2: Three-Stage LADDER Analysis", steps: [5, 6, 7, 8, 9] },
                3: { name: "Phase 3: Workshop Completion", steps: [10] }
            };
            
            // --- Function Definitions ---
            const toggleSettings = () => {
                const modal = document.getElementById('settingsModal');
                modal.style.display = (modal.style.display === 'block') ? 'none' : 'block';
                if (modal.style.display === 'block') {
                    renderScenarioEditors();
                }
            };

            const renderScenarioEditors = () => {
                const container = document.getElementById('scenarioEditors');
                container.innerHTML = '';
                const scenarioKeys = Object.keys(scenarios);

                scenarioKeys.forEach(key => {
                    const scenario = scenarios[key];
                    const editorHtml = `
                        <div class="scenario-editor" id="editor-${key}">
                            <button class="remove-scenario-btn" data-key="${key}">${scenarioKeys.length <= 4 ? '' : '√ó'}</button>
                            <h4>Scenario ${key}</h4>
                            <div class="editor-field">
                                <label>Title</label>
                                <input type="text" id="title-${key}" value="${scenario.title}">
                            </div>
                            <div class="editor-field">
                                <label>Description (10-Year Outlook)</label>
                                <textarea id="description-${key}">${scenario.description}</textarea>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', editorHtml);
                });
                
                document.querySelectorAll('.remove-scenario-btn').forEach(btn => btn.disabled = scenarioKeys.length <= 4);
                document.getElementById('addScenarioBtn').disabled = scenarioKeys.length >= 6;
            };

            const addScenario = () => {
                const scenarioKeys = Object.keys(scenarios);
                if (scenarioKeys.length < 6) {
                    const newKey = scenarioKeys.length > 0 ? Math.max(...scenarioKeys.map(Number)) + 1 : 1;
                    scenarios[newKey] = { title: `Scenario ${newKey} Title`, description: 'Describe the new scenario here...' };
                    renderScenarioEditors();
                }
            };

            const removeScenario = (key) => {
                const scenarioKeys = Object.keys(scenarios);
                if (scenarioKeys.length > 4) {
                    delete scenarios[key];
                    const remainingScenarios = Object.values(scenarios);
                    scenarios = {};
                    remainingScenarios.forEach((scenario, index) => {
                        scenarios[index + 1] = scenario;
                    });
                    renderScenarioEditors();
                }
            };

            const saveScenarios = async () => {
                const newScenarios = {};
                const editorContainer = document.getElementById('scenarioEditors');
                const editorKeys = Array.from(editorContainer.children).map(div => div.id.split('-')[1]);

                editorKeys.forEach((key, index) => {
                    const newKey = index + 1;
                    newScenarios[newKey] = {
                        title: document.getElementById(`title-${key}`).value,
                        description: document.getElementById(`description-${key}`).value
                    };
                });
                
                try {
                    await setDoc(scenariosDocRef, { content: JSON.stringify(newScenarios) });
                    console.log("Scenarios saved to Firestore.");
                } catch (error) {
                    console.error("Error saving scenarios to Firestore: ", error);
                }
                
                toggleSettings();
            };
            
            const updateScenarioDisplay = () => {
                const container = document.getElementById('scenario-probability-container');
                container.innerHTML = '';
                const scenarioCount = Object.keys(scenarios).length;
                if (scenarioCount === 0) return;

                const initialProb = Math.floor(100 / scenarioCount);
                
                Object.keys(scenarios).forEach((key, index) => {
                    const scenario = scenarios[key];
                    let currentProb = initialProb;
                    if (index === 0) {
                        currentProb += 100 % scenarioCount;
                    }
                    workshopData.probabilities[key] = currentProb;

                    const scenarioHtml = `
                    <div class="scenario-probability">
                        <div class="scenario-title">${scenario.title}</div>
                        <div class="scenario-description">${scenario.description.substring(0, 150)}...</div>
                        <div class="probability-control">
                            <span>Probability:</span>
                            <input type="range" class="probability-slider" id="prob${key}" min="0" max="100" value="${currentProb}">
                            <span class="probability-value" id="probValue${key}">${currentProb}%</span>
                        </div>
                    </div>`;
                    container.innerHTML += scenarioHtml;
                });
                updateProbabilities();
            };
            
            const nextStep = () => {
                if (validateCurrentStep()) {
                    saveStepData();
                    
                    if (currentStep < totalSteps) {
                        document.getElementById(`step${currentStep}`).classList.remove('active');
                        currentStep++;
                        document.getElementById(`step${currentStep}`).classList.add('active');
                        updateProgress();
                        updatePhase();
                        prepareStep();
                    }
                }
            };
            
            const prevStep = () => {
                if (currentStep > 1) {
                    document.getElementById(`step${currentStep}`).classList.remove('active');
                    currentStep--;
                    document.getElementById(`step${currentStep}`).classList.add('active');
                    updateProgress();
                    updatePhase();
                }
            };
            
            const updateProgress = () => {
                const progressFill = document.getElementById('progressFill');
                if (progressFill) {
                    const progress = (currentStep / totalSteps) * 100;
                    progressFill.style.width = progress + '%';
                }
            };
            
            const updatePhase = () => {
                let currentPhase = 1;
                for (let phase in phases) {
                    if (phases[phase].steps.includes(currentStep)) {
                        currentPhase = phase;
                        break;
                    }
                }
                
                const indicator = document.getElementById('phaseIndicator');
                if(indicator) {
                    indicator.textContent = phases[currentPhase].name;
                    indicator.className = 'phase-indicator active';
                }
            };
            
            const validateCurrentStep = () => true;
            
            const saveStepData = () => {
                switch(currentStep) {
                    case 1:
                        workshopData.teamName = document.getElementById('teamName').value;
                        workshopData.teamContext = document.getElementById('teamContext').value;
                        break;
                    case 3:
                        workshopData.uncertainties = [
                            document.getElementById('uncertainty1').value,
                            document.getElementById('uncertainty2').value,
                            document.getElementById('uncertainty3').value
                        ].filter(u => u.trim());
                        workshopData.industryContext = document.getElementById('industryContext').value;
                        break;
                    case 4:
                        workshopData.synthesizedFuture = document.getElementById('synthesizedFutureText').value;
                        break;
                    case 5:
                        workshopData.goal = {
                            lead: document.getElementById('goalLead').value,
                            anchor: document.getElementById('goalAnchor').value,
                            detail: document.getElementById('goalDetail').value,
                            declare: document.getElementById('goalDeclare').value,
                            explain: document.getElementById('goalExplain').value,
                            request: document.getElementById('goalRequest').value
                        };
                        generateGoalPrompt();
                        break;
                    case 6:
                        workshopData.goal.aiResponse = document.getElementById('goalAIResponse').value;
                        break;
                    case 7:
                        workshopData.assumptions = {
                            lead: document.getElementById('assumptionLead').value,
                            anchor: document.getElementById('assumptionAnchor').value,
                            detail: document.getElementById('assumptionDetail').value,
                            declare: document.getElementById('assumptionDeclare').value,
                            explain: document.getElementById('assumptionExplain').value,
                            request: document.getElementById('assumptionRequest').value
                        };
                        generateAssumptionPrompt();
                        break;
                    case 8:
                        workshopData.assumptions.aiResponse = document.getElementById('assumptionAIResponse').value;
                        break;
                    case 9:
                        workshopData.pathways = {
                            lead: document.getElementById('pathwayLead').value,
                            anchor: document.getElementById('pathwayAnchor').value,
                            detail: document.getElementById('pathwayDetail').value,
                            declare: document.getElementById('pathwayDeclare').value,
                            explain: document.getElementById('pathwayExplain').value,
                            request: document.getElementById('pathwayRequest').value
                        };
                        generatePathwayPrompt();
                        break;
                }
            };
            
            const prepareStep = () => {
                switch(currentStep) {
                    case 3:
                        displayProbabilitySummary();
                        break;
                    case 5:
                        document.getElementById('futureScenarioSummary').textContent = workshopData.synthesizedFuture.substring(0, 200) + '...';
                        break;
                    case 6:
                        document.getElementById('step6Next').disabled = workshopData.goal.aiResponse.trim().length < 50;
                        break;
                    case 7:
                        document.getElementById('goalSummary').textContent = workshopData.goal.lead;
                        break;
                    case 8:
                        document.getElementById('step8Next').disabled = workshopData.assumptions.aiResponse.trim().length < 50;
                        break;
                    case 9:
                        document.getElementById('pathwaySummary').textContent = 
                            `Goal: ${workshopData.goal.lead.substring(0, 100)}... | Key assumptions validated`;
                        break;
                    case 10:
                        prepareFinalSummary();
                        break;
                }
            };
            
            const updateProbabilities = () => {
                let total = 0;
                Object.keys(scenarios).forEach(key => {
                    const slider = document.getElementById(`prob${key}`);
                    if(slider) {
                        const value = parseInt(slider.value);
                        workshopData.probabilities[key] = value;
                        document.getElementById(`probValue${key}`).textContent = value + '%';
                        total += value;
                    }
                });
                
                const totalDiv = document.getElementById('totalProbability');
                if (!totalDiv) return;

                totalDiv.querySelector('span').textContent = total + '%';
                
                if (total === 100) {
                    totalDiv.classList.remove('invalid');
                    totalDiv.classList.add('valid');
                    document.getElementById('step2Next').disabled = false;
                } else {
                    totalDiv.classList.remove('valid');
                    totalDiv.classList.add('invalid');
                    document.getElementById('step2Next').disabled = true;
                }
            };
            
            const displayProbabilitySummary = () => {
                let summary = '<div style="display: grid; gap: 10px;">';
                Object.keys(scenarios).forEach(key => {
                    if (workshopData.probabilities[key] > 0) {
                        summary += `<div><strong>${scenarios[key].title}:</strong> ${workshopData.probabilities[key]}%</div>`;
                    }
                });
                summary += '</div>';
                document.getElementById('probabilitySummary').innerHTML = summary;
            };
            
            const generateFutureSynthesis = () => {
                const probText = Object.keys(scenarios).map(key => {
                    const prob = workshopData.probabilities[key];
                    const scenario = scenarios[key];
                    return `${prob}% - ${scenario.title}\n${scenario.description}`;
                }).join('\n\n');
                
                const uncertainties = workshopData.uncertainties.length > 0 
                    ? workshopData.uncertainties.join(', ') 
                    : 'No specific uncertainties identified';
                
                const prompt = `TEAM: ${workshopData.teamName}
TYPE: PROBABILISTIC FUTURE SYNTHESIS FOR 2027

LEAD: Synthesize a coherent 2027 future scenario for our business context. Blend the following long-term (10-year) scenarios based on the probability weights your team assigned. Create a narrative that describes what our world looks like two years from now.

LONG-TERM SCENARIOS & PROBABILITIES:
${probText}

ANCHOR: Our specific business/industry context: ${workshopData.industryContext}. Our key uncertainties: ${uncertainties}.

DETAIL: Create a narrative that reflects the weighted blend of the long-term scenarios. Scenarios with higher probabilities should have a stronger influence on the 2027 future, while lower-probability scenarios can add nuance or represent emerging risks/opportunities. The narrative must feel concrete and directly relevant to our business context.

REQUEST: Provide a 400-500 word narrative describing our 2027 future that:
(1) Authentically reflects the probability weights of the long-term scenarios.
(2) Is grounded in our specific industry context.
(3) Addresses how our stated uncertainties might play out in the next two years.
(4) Feels concrete with specific examples, not generic.
(5) Provides clear implications for setting a new business goal in this 2027 future.

---
Generated by Probabilistic Future Synthesis | Chock`;
                
                document.getElementById('synthesisPrompt').style.display = 'block';
                document.getElementById('synthesisPrompt').textContent = prompt;
                document.getElementById('copySynthesisBtn').style.display = 'block';
                
                document.getElementById('synthesizedFutureText').addEventListener('input', function() {
                    document.getElementById('step4Next').disabled = this.value.trim().length < 50;
                });
            };
            
            const generateGoalPrompt = () => {
                saveStepData();
                const prompt = `TEAM: ${workshopData.teamName}
TYPE: GOAL SETTING ANALYSIS
CONTEXT: Based on synthesized 2027 future scenario

LEAD: ${workshopData.goal.lead}
ANCHOR: ${workshopData.goal.anchor}
DETAIL: ${workshopData.goal.detail}
DECLARE: ${workshopData.goal.declare}
EXPLAIN: ${workshopData.goal.explain}
REQUEST: ${workshopData.goal.request}

---
Generated by LADDER Goal Analysis | Chock`;
                
                document.getElementById('goalPromptOutput').textContent = prompt;
                
                document.getElementById('goalAIResponse').addEventListener('input', function() {
                    document.getElementById('step6Next').disabled = this.value.trim().length < 50;
                });
            };
            
            const generateAssumptionPrompt = () => {
                saveStepData();
                const prompt = `TEAM: ${workshopData.teamName}
TYPE: ASSUMPTION MAPPING
CONTEXT: For goal - "${workshopData.goal.lead}"

LEAD: ${workshopData.assumptions.lead}
ANCHOR: ${workshopData.assumptions.anchor}
DETAIL: ${workshopData.assumptions.detail}
DECLARE: ${workshopData.assumptions.declare}
EXPLAIN: ${workshopData.assumptions.explain}
REQUEST: ${workshopData.assumptions.request}

---
Generated by LADDER Assumption Analysis | Chock`;
                
                document.getElementById('assumptionPromptOutput').textContent = prompt;
                
                document.getElementById('assumptionAIResponse').addEventListener('input', function() {
                    document.getElementById('step8Next').disabled = this.value.trim().length < 50;
                });
            };
            
            const generatePathwayPrompt = () => {
                saveStepData();
                const prompt = `TEAM: ${workshopData.teamName}
TYPE: PATHWAY DEVELOPMENT
CONTEXT: From current state to goal - "${workshopData.goal.lead}"

LEAD: ${workshopData.pathways.lead}
ANCHOR: ${workshopData.pathways.anchor}
DETAIL: ${workshopData.pathways.detail}
DECLARE: ${workshopData.pathways.declare}
EXPLAIN: ${workshopData.pathways.explain}
REQUEST: ${workshopData.pathways.request}

---
Generated by LADDER Pathway Analysis | Chock`;
                
                document.getElementById('pathwayPromptOutput').textContent = prompt;
                
                document.getElementById('pathwayAIResponse').addEventListener('input', function() {
                    workshopData.pathways.aiResponse = this.value;
                });
            };
            
            const copyPrompt = (elementId) => {
                const text = document.getElementById(elementId).textContent;
                navigator.clipboard.writeText(text).then(() => {
                    const btn = event.target;
                    const originalText = btn.textContent;
                    btn.textContent = '‚úì Copied!';
                    btn.style.background = '#4caf50';
                    
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy:', err);
                });
            };
            
            const prepareFinalSummary = () => {
                document.getElementById('futureBrief').textContent = 
                    workshopData.synthesizedFuture.substring(0, 150) + '...';
                
                document.getElementById('goalBrief').textContent = 
                    workshopData.goal.lead.substring(0, 150) + '...';
                
                if (workshopData.assumptions.aiResponse) {
                    const assumptionMatches = workshopData.assumptions.aiResponse.match(/\d+[-\s\.]/g);
                    if (assumptionMatches) {
                        document.getElementById('assumptionCount').textContent = 
                            `${assumptionMatches.length} critical assumptions identified`;
                    }
                }
                
                if (workshopData.pathways.aiResponse) {
                    const pathwayMatches = workshopData.pathways.aiResponse.match(/pathway|route|approach/gi);
                    if (pathwayMatches) {
                        document.getElementById('pathwayCount').textContent = 
                            `${Math.min(pathwayMatches.length, 5)} implementation pathways mapped`;
                    }
                }
            };
            
            const exportWorkshop = () => {
                let exportContent = `AI INNOVATION WORKSHOP RESULTS
Team: ${workshopData.teamName}
Date: ${new Date().toLocaleDateString()}

==========================================
PROBABILISTIC FUTURE SCENARIO (2027)
==========================================

Probability Distribution:
${Object.keys(scenarios).map(key => 
    `- ${scenarios[key].title}: ${workshopData.probabilities[key] || 0}%`
).join('\n')}

Key Uncertainties:
${workshopData.uncertainties.map(u => `- ${u}`).join('\n')}

Industry Context:
${workshopData.industryContext}

Synthesized Future (2027):
${workshopData.synthesizedFuture}

==========================================
BREAKTHROUGH GOAL
==========================================

${workshopData.goal.lead || ''}

AI Analysis:
${workshopData.goal.aiResponse || 'Not provided'}

==========================================
CRITICAL ASSUMPTIONS
==========================================

${workshopData.assumptions.lead || ''}

AI Analysis:
${workshopData.assumptions.aiResponse || 'Not provided'}

==========================================
IMPLEMENTATION PATHWAYS
==========================================

${workshopData.pathways.lead || ''}

AI Analysis:
${workshopData.pathways.aiResponse || 'Not provided'}

==========================================
NEXT STEPS
==========================================

1. Begin assumption testing with highest-risk items
2. Establish monitoring system for probability validation
3. Launch first pathway initiatives
4. Schedule quarterly probability reassessment
5. Build partnerships for ecosystem development

---
Generated by AI Innovation Workshop | Chock
${new Date().toLocaleString()}`;
                
                const blob = new Blob([exportContent], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `AI_Workshop_${workshopData.teamName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            };
            
            const printWorkshop = () => window.print();
            
            const restartWorkshop = () => {
                localStorage.removeItem('workshopData');
                localStorage.removeItem('currentStep');
                location.reload();
            };
            
            const saveProgress = () => {
                localStorage.setItem('workshopData', JSON.stringify(workshopData));
                localStorage.setItem('currentStep', currentStep);
            };
            
            const restoreFormData = () => {
                if (workshopData.teamName) {
                    document.getElementById('teamName').value = workshopData.teamName;
                    document.getElementById('teamContext').value = workshopData.teamContext || '';
                }
            };

            const attachEventListeners = () => {
                // Settings Modal
                document.getElementById('settingsBtn').addEventListener('click', toggleSettings);
                document.getElementById('closeSettingsBtn').addEventListener('click', toggleSettings);
                document.getElementById('addScenarioBtn').addEventListener('click', addScenario);
                document.getElementById('saveSettingsBtn').addEventListener('click', saveScenarios);
                document.getElementById('scenarioEditors').addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-scenario-btn') && !e.target.disabled) {
                        removeScenario(e.target.dataset.key);
                    }
                });

                // Step Navigation
                document.getElementById('step1Next').addEventListener('click', nextStep);
                document.getElementById('step2Prev').addEventListener('click', prevStep);
                document.getElementById('step2Next').addEventListener('click', nextStep);
                document.getElementById('step3Prev').addEventListener('click', prevStep);
                document.getElementById('step3Next').addEventListener('click', nextStep);
                document.getElementById('step4Prev').addEventListener('click', prevStep);
                document.getElementById('step4Next').addEventListener('click', nextStep);
                document.getElementById('step5Prev').addEventListener('click', prevStep);
                document.getElementById('step5Next').addEventListener('click', nextStep);
                document.getElementById('step6Prev').addEventListener('click', prevStep);
                document.getElementById('step6Next').addEventListener('click', nextStep);
                document.getElementById('step7Prev').addEventListener('click', prevStep);
                document.getElementById('step7Next').addEventListener('click', nextStep);
                document.getElementById('step8Prev').addEventListener('click', prevStep);
                document.getElementById('step8Next').addEventListener('click', nextStep);
                document.getElementById('step9Prev').addEventListener('click', prevStep);
                document.getElementById('step9Next').addEventListener('click', nextStep);

                // Probability Sliders (Event Delegation)
                document.getElementById('scenario-probability-container').addEventListener('input', (e) => {
                    if (e.target.classList.contains('probability-slider')) {
                        updateProbabilities();
                    }
                });

                // Prompt Generation & Copy
                document.getElementById('generateFutureBtn').addEventListener('click', generateFutureSynthesis);
                document.getElementById('copySynthesisBtn').addEventListener('click', () => copyPrompt('synthesisPrompt'));
                document.getElementById('copyGoalBtn').addEventListener('click', () => copyPrompt('goalPromptOutput'));
                document.getElementById('copyAssumptionBtn').addEventListener('click', () => copyPrompt('assumptionPromptOutput'));
                document.getElementById('copyPathwayBtn').addEventListener('click', () => copyPrompt('pathwayPromptOutput'));

                // Final Actions
                document.getElementById('exportBtn').addEventListener('click', exportWorkshop);
                document.getElementById('printBtn').addEventListener('click', printWorkshop);
                document.getElementById('restartBtn').addEventListener('click', restartWorkshop);
            };

            // --- Initialization ---
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    console.log("User authenticated, UID:", user.uid);
                    // Now that we're authenticated, set up the real-time listener
                    onSnapshot(scenariosDocRef, (doc) => {
                        console.log("Received scenarios update from Firestore.");
                        if (doc.exists()) {
                            const data = doc.data();
                            if (data.content) {
                                scenarios = JSON.parse(data.content);
                                console.log("Loaded scenarios:", scenarios);
                            }
                        } else {
                            console.log("No scenarios document found in Firestore. Using local defaults.");
                        }
                        updateScenarioDisplay();
                    }, (error) => {
                        console.error("Error listening to scenario updates:", error);
                    });

                    // Restore progress after we have user auth and initial data
                    const savedData = localStorage.getItem('workshopData');
                    const savedStep = localStorage.getItem('currentStep');
                    
                    if (savedData && savedStep) {
                        workshopData = JSON.parse(savedData);
                        currentStep = parseInt(savedStep);
                        
                        document.getElementById('step1').classList.remove('active');
                        document.getElementById(`step${currentStep}`).classList.add('active');
                        updateProgress();
                        updatePhase();
                        restoreFormData();
                    }
                } else {
                    console.log("User is not authenticated.");
                }
            });

            // Trigger the authentication flow
            (async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch(error) {
                    console.error("Error during sign-in:", error);
                }
            })();
            
            attachEventListeners();
            window.addEventListener('beforeunload', saveProgress);
        });
    </script>
</body>
</html>
